# SME Pulse - Schema Design & Layering Strategy

## ğŸ¯ CHUáº¨N NHáº¤T: Medallion Architecture vá»›i Star Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     LAKEHOUSE LAYERS                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  BRONZE (schema: bronze)                                    â”‚
â”‚  â”œâ”€ sales_snapshot_raw          â† Raw CSVs/APIs             â”‚
â”‚  â”œâ”€ payments_raw                â† Unchanged data            â”‚
â”‚  â”œâ”€ shipments_raw               â† Exact copy of source      â”‚
â”‚  â””â”€ bank_txn_raw                â† No transformations        â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  SILVER (schema: silver)                                    â”‚
â”‚  â”œâ”€ stg_orders_vn               â† Cleansed & Vietnamized    â”‚
â”‚  â”œâ”€ stg_payments_vn             â† Type casting              â”‚
â”‚  â”œâ”€ stg_shipments_vn            â† Timezone normalized       â”‚
â”‚  â”œâ”€ stg_bank_txn_vn             â† Currency â†’ VND            â”‚
â”‚  â””â”€ stg_ar_invoices_vn          â† âš ï¸ THÃŠM Má»šI              â”‚
â”‚                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  GOLD (schema: gold) â† â­ DIMS/FACTS á» ÄÃ‚Y                  â”‚
â”‚                                                             â”‚
â”‚  â”œâ”€ ğŸ“Š DIMENSIONS (Gold Conformed)                          â”‚
â”‚  â”‚   â”œâ”€ dim_date                â† SCD Type 0                â”‚
â”‚  â”‚   â”œâ”€ dim_customer            â† SCD Type 2 (history)      â”‚
â”‚  â”‚   â”œâ”€ dim_product             â† SCD Type 1                â”‚
â”‚  â”‚   â”œâ”€ dim_channel             â† SCD Type 0                â”‚
â”‚  â”‚   â”œâ”€ dim_payment_method      â† SCD Type 0                â”‚
â”‚  â”‚   â”œâ”€ dim_carrier             â† SCD Type 0                â”‚
â”‚  â”‚   â””â”€ dim_geo                 â† SCD Type 1                â”‚
â”‚  â”‚                                                          â”‚
â”‚  â”œâ”€ ğŸ“ˆ FACTS (Gold Grain Tables)                            â”‚
â”‚  â”‚   â”œâ”€ fact_orders             â† 1 row = 1 order line      â”‚
â”‚  â”‚   â”œâ”€ fact_payments           â† 1 row = 1 payment         â”‚
â”‚  â”‚   â”œâ”€ fact_shipments          â† 1 row = 1 shipment        â”‚
â”‚  â”‚   â””â”€ fact_bank_txn           â† 1 row = 1 bank txn        â”‚
â”‚  â”‚                                                          â”‚
â”‚  â”œâ”€ ğŸ”— LINKS (Gold Reconciliation)                         â”‚
â”‚  â”‚   â”œâ”€ link_order_payment      â† M:N bridge                â”‚
â”‚  â”‚   â”œâ”€ link_payment_bank       â† M:N bridge                â”‚
â”‚  â”‚   â””â”€ link_order_shipment     â† M:N bridge                â”‚
â”‚  â”‚                                                          â”‚
â”‚  â”œâ”€ ğŸ“Š KPI MARTS (Gold Aggregates)                         â”‚
â”‚  â”‚   â”œâ”€ daily_revenue           â† Business metrics          â”‚
â”‚  â”‚   â”œâ”€ payment_success_rate    â† Operational KPIs          â”‚
â”‚  â”‚   â””â”€ reconciliation_daily    â† Finance reports           â”‚
â”‚  â”‚                                                          â”‚
â”‚  â””â”€ ğŸ¤– ML FEATURES (Gold ML-Ready)                         â”‚
â”‚      â”œâ”€ ml_prophet_cashflow     â† Time series (ds, y)       â”‚
â”‚      â”œâ”€ ml_isolation_features   â† Anomaly detection         â”‚
â”‚      â””â”€ ml_ar_scoring_features  â† Classification labels     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ LÃ DO Táº I SAO?

### **Bronze = Raw Zone**
- NguyÃªn táº¯c: "Never touch, never delete"
- Schema: `bronze`
- Materialized: `table` hoáº·c external (Iceberg)
- Retention: Forever (hoáº·c theo compliance)

### **Silver = Cleaned Zone**  
- NguyÃªn táº¯c: "Single version of truth, denormalized staging"
- Schema: `silver`
- Materialized: `incremental` tables
- Purpose: **Phá»¥c vá»¥ Facts**, khÃ´ng pháº£i end-users

### **Gold = Analytics-Ready Zone** â­
- NguyÃªn táº¯c: "Star schema for humans & ML"
- Schema: `gold` (hoáº·c `analytics`, `warehouse`)
- Materialized: `table` cho dims, `incremental` cho facts
- Purpose: **Direct query by BI tools & ML pipelines**

---

## ğŸ“ QUY Táº®C THIáº¾T Káº¾

### âœ… **Dims/Facts PHáº¢I á» Gold** vÃ¬:

1. **Star schema = Gold standard**
   - Dims cÃ³ surrogate keys (dim_date.date_key)
   - Facts cÃ³ foreign keys (fact_orders.date_key)
   - End-users chá»‰ query Gold, khÃ´ng query Silver

2. **Silver = Staging only**
   - Silver cÃ³ thá»ƒ thay Ä‘á»•i logic (re-process)
   - Gold = stable contract vá»›i downstream (BI/ML)
   - Silver â†’ Gold = "promote to production"

3. **Governance & Security**
   - Gold cÃ³ row-level security, data masking
   - Silver = workspace, Gold = governed
   - Analysts chá»‰ cÃ³ quyá»n `SELECT gold.*`

4. **Performance**
   - Gold Ä‘Æ°á»£c optimize cho query (indexes, partitions)
   - Silver Ä‘Æ°á»£c optimize cho load (merge, dedup)

---

## ğŸ› ï¸ Sá»¬A Láº I CHO Cáº¬U

### 1ï¸âƒ£ **Cáº¥u trÃºc thÆ° má»¥c Ä‘Ãºng:**

```
models/
â”œâ”€ bronze.yml                # Sources
â”‚
â”œâ”€ silver/                   # Schema: silver
â”‚  â”œâ”€ stg_orders_vn.sql
â”‚  â”œâ”€ stg_payments_vn.sql
â”‚  â”œâ”€ stg_shipments_vn.sql
â”‚  â”œâ”€ stg_bank_txn_vn.sql
â”‚  â””â”€ stg_ar_invoices_vn.sql  â† âš ï¸ ThÃªm má»›i
â”‚
â””â”€ gold/                     # Schema: gold â­
   â”‚
   â”œâ”€ dims/
   â”‚  â”œâ”€ dim_date.sql
   â”‚  â”œâ”€ dim_customer.sql
   â”‚  â”œâ”€ dim_product.sql
   â”‚  â”œâ”€ dim_channel.sql
   â”‚  â”œâ”€ dim_payment_method.sql
   â”‚  â”œâ”€ dim_carrier.sql
   â”‚  â””â”€ dim_geo.sql
   â”‚
   â”œâ”€ facts/
   â”‚  â”œâ”€ fact_orders.sql
   â”‚  â”œâ”€ fact_payments.sql
   â”‚  â”œâ”€ fact_shipments.sql
   â”‚  â””â”€ fact_bank_txn.sql
   â”‚
   â”œâ”€ links/
   â”‚  â”œâ”€ link_order_payment.sql
   â”‚  â”œâ”€ link_payment_bank.sql
   â”‚  â””â”€ link_order_shipment.sql
   â”‚
   â”œâ”€ kpi/                   # â† TÃ¡ch riÃªng KPIs
   â”‚  â”œâ”€ daily_revenue.sql
   â”‚  â”œâ”€ payment_success_rate.sql
   â”‚  â””â”€ reconciliation_daily.sql
   â”‚
   â””â”€ ml/                    # â† TÃ¡ch riÃªng ML features
      â”œâ”€ ml_prophet_cashflow.sql
      â”œâ”€ ml_isolation_features.sql
      â””â”€ ml_ar_scoring.sql
```

### 2ï¸âƒ£ **dbt_project.yml config:**

```yaml
name: sme_pulse
version: 1.0.0
config-version: 2

profile: sme_pulse

model-paths: ["models"]
seed-paths: ["seeds"]
macro-paths: ["macros"]

models:
  sme_pulse:
    # Silver models â†’ schema: silver
    silver:
      +materialized: incremental
      +schema: silver
      +on_schema_change: sync_all_columns
      +tags: ['silver', 'staging']
      
    # Gold models â†’ schema: gold â­
    gold:
      +schema: gold
      +tags: ['gold', 'production']
      
      dims:
        +materialized: table  # Dims lÃ  table
        +tags: ['dimensions']
        
      facts:
        +materialized: incremental  # Facts lÃ  incremental
        +unique_key: ['order_id']  # TÃ¹y fact
        +tags: ['facts']
        +on_schema_change: append_new_columns
        
      links:
        +materialized: incremental
        +tags: ['reconciliation']
        
      kpi:
        +materialized: incremental
        +tags: ['metrics', 'kpi']
        
      ml:
        +materialized: incremental
        +tags: ['ml', 'features']
```

### 3ï¸âƒ£ **profiles.yml (khÃ´ng cáº§n sá»­a schema):**

```yaml
sme_pulse:
  target: trino
  outputs:
    trino:
      type: trino
      method: none
      host: trino
      port: 8080
      database: iceberg
      schema: gold  # â† Default schema (khÃ´ng quan trá»ng láº¯m)
      threads: 4
```

**Giáº£i thÃ­ch:**
- `schema: gold` trong profiles = default khi khÃ´ng chá»‰ Ä‘á»‹nh
- **NHÆ¯NG** dbt sáº½ dÃ¹ng `+schema` trong `dbt_project.yml`
- Silver models â†’ tá»± Ä‘á»™ng vÃ o `iceberg.silver.*`
- Gold models â†’ tá»± Ä‘á»™ng vÃ o `iceberg.gold.*`

---

## ğŸ”„ FLOW EXECUTION (Tuáº§n tá»± vs Song song)

### **Stage 1: Silver (song song)**
```bash
dbt run --select silver.* --threads 4
# Output: iceberg.silver.stg_orders_vn, stg_payments_vn, ...
```

### **Stage 2: Gold Dims (song song)**
```bash
dbt run --select gold.dims.* --threads 7
# Output: iceberg.gold.dim_date, dim_customer, ...
```

### **Stage 3: Gold Facts (song song, nhÆ°ng phá»¥ thuá»™c Dims)**
```bash
dbt run --select gold.facts.* --threads 4
# Output: iceberg.gold.fact_orders, fact_payments, ...
# âš ï¸ fact_orders JOIN dim_channel â†’ pháº£i cÃ³ dims trÆ°á»›c
```

### **Stage 4: Gold Links (tuáº§n tá»± sau Facts)**
```bash
dbt run --select gold.links.*
# Output: iceberg.gold.link_order_payment, ...
# âš ï¸ JOIN fact_orders + fact_payments â†’ pháº£i cÃ³ facts trÆ°á»›c
```

### **Stage 5: Gold KPIs & ML (song song sau Links)**
```bash
dbt run --select gold.kpi.* gold.ml.* --threads 6
# Output: iceberg.gold.daily_revenue, ml_prophet_cashflow, ...
```

---

## ğŸ“Š DAG DEPENDENCIES (Lineage)

```
bronze.sales_snapshot_raw
  â†“
silver.stg_orders_vn
  â†“ (needs seeds)
gold.dim_channel â”€â”€â”
                   â”œâ”€â†’ gold.fact_orders â”€â”€â”
gold.dim_customer â”€â”˜                      â”‚
                                          â”œâ”€â†’ gold.link_order_payment
silver.stg_payments_vn                    â”‚        â†“
  â†“                                       â”‚   gold.kpi.payment_success_rate
gold.fact_payments â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â†“
                                            gold.ml.ml_prophet_cashflow
```

**Quy táº¯c:**
- Silver â†’ khÃ´ng phá»¥ thuá»™c Gold
- Dims â†’ khÃ´ng phá»¥ thuá»™c Facts
- Facts â†’ Cáº¦N Dims (Ä‘á»ƒ join láº¥y keys)
- Links â†’ Cáº¦N Facts (Ä‘á»ƒ reconcile)
- KPI/ML â†’ Cáº¦N Links (náº¿u cáº§n reconciliation data)

---

## âš ï¸ Váº¤N Äá»€ Cáº¬U CÃ“ THá»‚ Gáº¶P

### **Hiá»‡n táº¡i facts cá»§a cáº­u:**

```sql
-- fact_orders.sql (tá»« markdown cáº­u gá»­i)
select
  s.order_id_nat as order_id,
  cast(to_char(s.order_date, 'YYYYMMDD') as bigint) as date_key,
  dch.channel_code as channel_key,  -- â† JOIN dim
  ...
from {{ ref('stg_orders_vn') }} s
left join {{ ref('dim_channel') }} dch  -- â† Náº¾U dim chÆ°a cÃ³?
  on s.channel_code = dch.channel_code;
```

**Náº¿u dim_channel chÆ°a cháº¡y â†’ fact_orders fail!**

### **Giáº£i phÃ¡p: dbt selectors**

Táº¡o `selectors.yml`:
```yaml
selectors:
  - name: build_warehouse
    description: Build toÃ n bá»™ warehouse theo Ä‘Ãºng thá»© tá»±
    definition:
      union:
        - method: path
          value: models/silver
        - method: path
          value: models/gold/dims
        - method: path
          value: models/gold/facts
        - method: path
          value: models/gold/links
        - method: path
          value: models/gold/kpi
        - method: path
          value: models/gold/ml
```

**Cháº¡y:**
```bash
dbt build --selector build_warehouse
# dbt tá»± Ä‘á»™ng sort theo dependencies!
```

---

## ğŸ¯ TRáº¢ Lá»œI CÃ‚U Há»I Cá»¦A Cáº¬U

### â“ "Thiáº¿t káº¿ Silver vá»›i Dims/Facts á»•n rá»“i Ä‘Ãºng khÃ´ng?"

âœ… **Silver á»•n 90%** (chá»‰ thiáº¿u stg_ar_invoices)  
âœ… **Dims/Facts á»•n vá» logic**, NHÆ¯NG:
- âŒ Cáº§n move tá»« `models/dims`, `models/facts`
- âœ… Sang `models/gold/dims`, `models/gold/facts`

### â“ "BÆ°á»›c chuáº©n hÃ³a lÃ  Ä‘Æ°á»£c rá»“i Ä‘Ãºng khÃ´ng?"

âœ… **Chuáº©n hÃ³a á»Ÿ Silver = HOÃ€N Háº¢O**:
- Timezone, currency, Viá»‡t hÃ³a â†’ Ä‘Ãºng chá»—
- Äá»«ng thÃªm logic business vÃ o Silver
- Silver = technical cleaning only

### â“ "Aggregate lÃ  chÆ°a á»•n thÃ´i háº£?"

âœ… **ÄÃºng!** Aggregate (KPI, ML features) cáº§n:
- Time series rollups (daily, weekly)
- Window functions (7d avg, 30d std)
- Feature engineering (z-scores, ratios)
- â†’ Pháº£i lÃ m á»Ÿ `gold.kpi.*` vÃ  `gold.ml.*`

### â“ "Pháº£i lÃ m Dims/Facts trÆ°á»›c khi lÃ m KPI háº£?"

âœ… **ÄÃšNG Váº¬Y!** VÃ¬:
```sql
-- gold/kpi/daily_revenue.sql
SELECT 
  f.date_key,
  d.date_actual,  -- â† Cáº§n dim_date
  c.channel_name_vi,  -- â† Cáº§n dim_channel
  SUM(f.revenue)
FROM gold.fact_orders f
JOIN gold.dim_date d ON f.date_key = d.date_key
JOIN gold.dim_channel c ON f.channel_key = c.channel_code
GROUP BY 1,2,3;
```

**Thá»© tá»± báº¯t buá»™c:**
1. Silver (staging)
2. Dims (dimensions)
3. Facts (join dims Ä‘á»ƒ láº¥y keys)
4. Links (join facts Ä‘á»ƒ reconcile)
5. KPI/ML (aggregate facts + dims)

### â“ "Dims/Facts lÆ°u á»Ÿ schema Gold hay Silver?"

âœ… **GOLD!** (iceberg.gold.dim_*, iceberg.gold.fact_*)  

**LÃ DO:**
- Silver = workspace (unstable)
- Gold = production (stable star schema)
- BI tools query Gold, khÃ´ng query Silver
- Dims/Facts = pháº§n cá»§a star schema â†’ pháº£i á»Ÿ Gold

---

## ğŸ“‹ CHECKLIST CUá»I CÃ™NG

- [ ] Move `models/dims` â†’ `models/gold/dims`
- [ ] Move `models/facts` â†’ `models/gold/facts`
- [ ] Move `models/links` â†’ `models/gold/links`
- [ ] Update `dbt_project.yml` vá»›i `+schema: gold`
- [ ] ThÃªm `models/gold/kpi` folder
- [ ] ThÃªm `models/gold/ml` folder
- [ ] ThÃªm `stg_ar_invoices_vn.sql` vÃ o Silver
- [ ] Test: `dbt build --selector build_warehouse`
- [ ] Verify schemas: `SHOW TABLES IN iceberg.silver` vÃ  `iceberg.gold`

---

## ğŸš€ Lá»†NH CHáº Y HOÃ€N CHá»ˆNH

```bash
# 1. Seed seeds (vÃ o schema máº·c Ä‘á»‹nh, khÃ´ng quan trá»ng)
dbt seed

# 2. Build toÃ n bá»™ (dbt tá»± sort dependencies)
dbt build

# HOáº¶C tá»«ng bÆ°á»›c:

# 2a. Silver
dbt run --select silver.*

# 2b. Gold Dims
dbt run --select gold.dims.*

# 2c. Gold Facts (depends on Dims)
dbt run --select gold.facts.*

# 2d. Gold Links (depends on Facts)
dbt run --select gold.links.*

# 2e. Gold KPIs & ML (depends on Links)
dbt run --select gold.kpi.* gold.ml.*

# 3. Tests
dbt test
```

---

## ğŸ“š TÃ€I LIá»†U THAM KHáº¢O

- [Medallion Architecture (Databricks)](https://www.databricks.com/glossary/medallion-architecture)
- [dbt Best Practices - Schema Organization](https://docs.getdbt.com/guides/best-practices/how-we-structure/1-guide-overview)
- [Kimball Star Schema Design](https://www.kimballgroup.com/data-warehouse-business-intelligence-resources/kimball-techniques/dimensional-modeling-techniques/)

---

Cáº­u cÃ²n tháº¯c máº¯c gÃ¬ vá» schemas khÃ´ng? Hoáº·c muá»‘n tá»› viáº¿t chi tiáº¿t hÆ¡n vá» pháº§n nÃ o? ğŸ¯
